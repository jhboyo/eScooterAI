# IoU (Intersection over Union) 임계값 가이드

## 📊 IoU란?

**IoU (Intersection over Union)**는 객체 탐지에서 **두 바운딩 박스가 얼마나 겹치는지를 나타내는 지표**입니다.

### 계산 방식

```
IoU = (겹치는 영역의 면적) / (두 박스의 합집합 영역의 면적)
```

**수식:**
```
IoU = Area(Box A ∩ Box B) / Area(Box A ∪ Box B)
```

### 값의 범위

- **0.0**: 두 박스가 전혀 겹치지 않음
- **0.5**: 두 박스가 절반 정도 겹침
- **1.0**: 두 박스가 완전히 일치

---

## 🎯 실제 용도: NMS (Non-Maximum Suppression)

### 문제 상황

YOLO와 같은 객체 탐지 모델은 **같은 객체를 여러 번 탐지**하는 경우가 많습니다:

```
예시: 건설 현장의 작업자
┌─────────┐
│ 헬멧 1  │ (신뢰도: 0.95)
└─────────┘
  ┌─────────┐
  │ 헬멧 2  │ (신뢰도: 0.87)
  └─────────┘
    ┌─────────┐
    │ 헬멧 3  │ (신뢰도: 0.72)
    └─────────┘

→ 실제로는 1개의 헬멧이지만 3번 탐지됨!
```

### NMS의 역할

**중복된 탐지 결과를 제거**하여 각 객체당 하나의 박스만 남깁니다.

#### NMS 알고리즘 작동 방식

1. **신뢰도 순으로 정렬**: 가장 높은 신뢰도의 박스부터 처리
2. **IoU 계산**: 선택된 박스와 나머지 박스들의 IoU 계산
3. **중복 제거**: IoU > 임계값인 박스들을 중복으로 간주하고 제거
4. **반복**: 남은 박스들에 대해 1-3 과정 반복

### IoU 임계값의 역할

```
예시: IoU 임계값 = 0.45

상황: 박스 A와 박스 B가 50% 겹침 (IoU = 0.5)

판단:
- IoU (0.5) > 임계값 (0.45)
- → 두 박스가 같은 객체를 탐지한 것으로 간주
- → 신뢰도가 낮은 박스 B 제거
- → 박스 A만 최종 결과로 유지
```

---

## ⚙️ IoU 임계값 설정 가이드

### 임계값별 효과 비교

| 임계값 | 중복 판단 기준 | 효과 | 장점 | 단점 |
|--------|--------------|------|------|------|
| **낮음 (0.3)** | 조금만 겹쳐도 중복 | 많이 제거 | 깔끔한 결과 | 일부 객체 누락 가능 |
| **중간 (0.45)** | 적당히 겹치면 중복 | 균형있게 제거 | **대부분의 경우 최적** ✅ | - |
| **높음 (0.7)** | 많이 겹쳐야 중복 | 적게 제거 | 모든 탐지 보존 | 중복 박스 많이 남음 |

### 권장 설정

#### 일반적인 경우 (권장)
```yaml
IoU 임계값: 0.45 ~ 0.5
```
- 대부분의 객체 탐지 작업에 적합
- YOLOv8 기본값도 0.45

#### 밀집된 환경 (작업자들이 가까이 있음)
```yaml
IoU 임계값: 0.5 ~ 0.6
```
- 건설 현장처럼 사람들이 가까이 있는 경우
- 겹치는 객체를 별개로 인식

#### 깔끔한 결과 필요 (프레젠테이션용)
```yaml
IoU 임계값: 0.3 ~ 0.4
```
- 중복 박스 최소화
- 시각적으로 깔끔한 결과

---

## 💡 실무 예시

### 케이스 1: 작업자 3명이 가까이 있는 상황

```
현장 상황:
[작업자A] [작업자B] [작업자C]
   😊        😊        😊
```

#### IoU = 0.3 (낮음, 엄격)

```
탐지 결과:
┌────────────────────┐
│ Helmet (0.95)     │  ← 작업자 A+B 하나로 합쳐짐
└────────────────────┘
           ┌──────────┐
           │ Helmet   │  ← 작업자 C
           └──────────┘

결과: 2개 탐지 (❌ 1명 누락!)
```

#### IoU = 0.45 (중간, 권장)

```
탐지 결과:
┌─────────┐
│ Helmet  │  ← 작업자 A
└─────────┘
  ┌─────────┐
  │ Helmet  │  ← 작업자 B
  └─────────┘
    ┌─────────┐
    │ Helmet  │  ← 작업자 C
    └─────────┘

결과: 3개 정확히 탐지 (✅)
```

#### IoU = 0.7 (높음, 관대)

```
탐지 결과:
┌─────────┐┌────────┐
│ Helmet  ││Helmet  │  ← 작업자 A (중복)
└─────────┘└────────┘
  ┌─────────┐┌────────┐
  │ Helmet  ││Helmet  │  ← 작업자 B (중복)
  └─────────┘└────────┘
    ┌─────────┐
    │ Helmet  │  ← 작업자 C
    └─────────┘

결과: 5개 탐지 (❌ 중복 발생!)
```

### 케이스 2: 헬멧 착용률 계산

#### 상황
- 실제: 헬멧 착용 2명, 미착용 1명
- 작업자들이 가까이 서 있음

#### 잘못된 설정 (IoU = 0.3)
```
탐지 결과:
- Helmet: 1개 (2명이 하나로 합쳐짐)
- Head: 1개

계산된 착용률: 50% (1/2)
실제 착용률: 66.7% (2/3)

→ 부정확한 안전 평가!
```

#### 올바른 설정 (IoU = 0.45)
```
탐지 결과:
- Helmet: 2개
- Head: 1개

계산된 착용률: 66.7% (2/3)
실제 착용률: 66.7% (2/3)

→ 정확한 안전 평가! ✅
```

---

## 🔧 Safety Vision AI에서의 설정

### 현재 기본값

```python
# src/web_interface/app.py
iou_threshold = st.slider(
    "IoU 임계값",
    min_value=0.1,
    max_value=1.0,
    value=0.45,  # 기본값
    step=0.05,
    help="NMS(Non-Maximum Suppression)를 위한 IoU 임계값"
)
```

### 설정 방법

1. **웹 대시보드 실행**
   ```bash
   uv run streamlit run src/web_interface/app.py
   ```

2. **사이드바에서 조정**
   - "⚙️ 설정" → "🔧 고급 옵션" 클릭
   - "IoU 임계값" 슬라이더 조정
   - 실시간으로 변경 가능

### 건설 현장 권장 설정

```yaml
작업 환경: 건설 현장
작업자 밀집도: 중간~높음

권장 IoU: 0.45 ~ 0.5

이유:
- 작업자들이 가까이 있어도 개별 구분 가능
- 중복 탐지 최소화
- 정확한 헬멧 착용률 계산
```

---

## 📈 성능 영향

### 처리 속도

IoU 임계값은 **추론 속도에 거의 영향 없음**:
- NMS는 추론 후 후처리 단계
- 계산량이 매우 적음
- 실시간 처리 가능

### 정확도 영향

| IoU | Precision (정밀도) | Recall (재현율) |
|-----|-------------------|----------------|
| 0.3 | 높음 ⬆️ | 낮음 ⬇️ |
| 0.45 | 균형 ✅ | 균형 ✅ |
| 0.7 | 낮음 ⬇️ | 높음 ⬆️ |

---

## 🎓 관련 개념

### 1. Confidence Threshold (신뢰도 임계값)

```
역할: 탐지할지 말지 결정
IoU와의 차이:
- Confidence: "이게 객체인가?" 판단
- IoU: "이 둘이 같은 객체인가?" 판단
```

### 2. Max Detections (최대 탐지 수)

```
역할: 이미지당 최대 몇 개까지 탐지할지 제한
IoU와의 관계:
- IoU로 중복 제거 후
- Max Detections 제한 적용
```

### 처리 순서

```
1. YOLO 추론 → 수많은 바운딩 박스 생성
2. Confidence 필터링 → 신뢰도 낮은 박스 제거
3. NMS (IoU 사용) → 중복 박스 제거
4. Max Detections 적용 → 상위 N개만 선택
5. 최종 결과 반환
```

---

## 🔍 디버깅 팁

### IoU 설정이 올바른지 확인하는 방법

1. **시각적 확인**
   - 탐지 결과 이미지 확인
   - 중복 박스가 많으면 → IoU 높이기
   - 객체 누락이 많으면 → IoU 낮추기

2. **통계 확인**
   - 같은 이미지를 여러 IoU 값으로 테스트
   - 탐지 개수 비교
   - 급격한 변화가 있는 구간 찾기

3. **헬멧 착용률 검증**
   - 수동으로 카운트한 값과 비교
   - 오차가 크면 IoU 조정

### 문제 해결

| 증상 | 원인 | 해결 방법 |
|------|------|----------|
| 같은 사람이 여러 번 탐지됨 | IoU 너무 높음 | IoU 낮추기 (0.4~0.5) |
| 가까이 있는 사람들이 1명으로 탐지됨 | IoU 너무 낮음 | IoU 높이기 (0.5~0.6) |
| 헬멧 착용률이 실제보다 낮게 나옴 | 작업자 수 과대 탐지 | IoU 낮추기 |
| 헬멧 착용률이 실제보다 높게 나옴 | 작업자 수 과소 탐지 | IoU 높이기 |

---

## 📚 참고 자료

### 논문
- [Non-Maximum Suppression (NMS)](https://arxiv.org/abs/1704.04503)
- [YOLO: You Only Look Once](https://arxiv.org/abs/1506.02640)

### 공식 문서
- [Ultralytics YOLOv8 Documentation](https://docs.ultralytics.com/)
- [YOLOv8 Parameters](https://docs.ultralytics.com/modes/predict/#inference-arguments)

### 관련 자료
- `README.md`: 프로젝트 전체 개요
- `WEB_PLAN.md`: 웹 인터페이스 구현 계획
- `src/web_interface/utils/inference.py`: 추론 코드 구현

---

## ✅ 요약

### 핵심 포인트

1. **IoU는 박스 겹침 정도를 측정** (0.0 ~ 1.0)
2. **NMS에서 중복 제거 기준으로 사용**
3. **건설 현장 권장값: 0.45 ~ 0.5**
4. **너무 낮으면**: 객체 누락 발생
5. **너무 높으면**: 중복 탐지 발생

### Quick Start

```python
# 일반적인 경우
iou_threshold = 0.45

# 밀집된 환경
iou_threshold = 0.5

# 깔끔한 결과 필요
iou_threshold = 0.35
```

---

**Last Updated**: 2025-11-22
**Author**: Safety Vision AI Team
**Related**: `README.md`, `WEB_PLAN.md`, `src/web_interface/utils/inference.py`
